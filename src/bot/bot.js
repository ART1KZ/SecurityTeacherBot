/**
 * ü§ñ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–û–¢–ê
 * 
 * –°–æ–∑–¥–∞—ë—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã:
 * - Grammy –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram API
 * - Supabase –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Ñ–∞–π–ª–æ–≤
 * - Mistral AI –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –∏ –ø–æ–∏—Å–∫–∞
 * - Session middleware –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * 
 * –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –æ–±—â–∏–µ –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –º–æ–¥—É–ª—è—Ö user/admin.
 */

import { Bot, session } from 'grammy';
import { hydrateFiles } from '@grammyjs/files';
import { createClient } from '@supabase/supabase-js';
import { Mistral } from '@mistralai/mistralai';

// –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º –∏–∑ .env
const bot = new Bot(process.env.BOT_TOKEN);

// –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–ª–∞–≥–∏–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞)
bot.api.config.use(hydrateFiles(bot.token));

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Supabase-–∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î –∏ Storage
const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_KEY // SERVICE_ROLE key –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Mistral AI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
const mistral = new Mistral({ apiKey: process.env.MISTRAL_API_KEY });

/**
 * –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
 * –•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â—É—é –∫–æ–º–∞–Ω–¥—É, –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ—Å—Ç–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–¥–º–∏–Ω–∫–∏.
 */
function initialSessionData() {
  return {
    command: null,           // –¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ ('search', 'test', 'admin')
    questions: [],           // ID –≤–æ–ø—Ä–æ—Å–æ–≤ —Ç–µ—Å—Ç–∞
    correctAnswers: [],      // ID –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
    isAdmin: false,          // –§–ª–∞–≥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∞
    renamingDocId: null,     // ID –¥–æ–∫—É–º–µ–Ω—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ—Ç—Å—è
    adminPromptMsgId: null,  // ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–ø—Ä–æ—Å–æ–º –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∫–∏
    renamePromptMsgId: null, // ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–ø—Ä–æ—Å–æ–º –Ω–æ–≤–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
  };
}

// –ü–æ–¥–∫–ª—é—á–∞–µ–º middleware –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–π
bot.use(session({ initial: initialSessionData }));

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞–¥–µ–Ω–∏—è –±–æ—Ç–∞
bot.catch((err) => {
  console.error('‚ùå –û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ:', err);
});

export { bot, supabase, mistral };
